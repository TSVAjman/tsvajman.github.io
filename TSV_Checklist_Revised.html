<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=1024" /> <!-- Preserves desktop layout on mobile -->
    <title>TSV Revised Checklist</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --primary-color: #008080;
            --light-bg: #f4f6f9;
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, sans-serif;
            color: #333;
            display: none; /* Hidden until PIN verified */
            margin: 0;
            padding: 0;
        }

        .main-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-top: 5px solid var(--primary-color);
            padding: 40px;
            margin: 30px auto;
            width: 1000px; /* Perfect desktop width */
        }

        /* Suggestion Box */
        #nameSuggestions {
            max-height: 250px;
            overflow-y: auto;
            z-index: 1050;
            background: white;
        }

        /* Table Alignment Fixes */
        .table { width: 100%; border-collapse: collapse; }
        .table thead th { background-color: #f8f9fa; color: var(--primary-color); border: 1px solid #dee2e6; }
        .table td { border: 1px solid #dee2e6; vertical-align: middle; }

        /* Signature */
        .signature-box {
            width: 100%;
            height: 120px;
            border: 2px dashed #ccc;
            background: #fff;
            cursor: crosshair;
            touch-action: none;
        }

        /* PRINT MIRRORING LOGIC */
        .print-val { display: none; }

        @media print {
            @page { 
                size: A4; 
                margin: 15mm 10mm; /* Standard A4 Margins */
            }
            body { 
                display: block !important; 
                background: white !important; 
                min-width: 100% !important; 
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            .no-print, .btn, .input-group-text, #nameSuggestions { display: none !important; }
            
            .main-container { 
                box-shadow: none !important; 
                border: none !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                width: 100% !important; 
                max-width: 100% !important;
            }
            
            /* Hide UI elements and show the mirrored text spans */
            input, textarea, select { display: none !important; }
            .print-val { 
                display: block !important; 
                width: 100% !important; 
                white-space: pre-wrap !important; 
                word-wrap: break-word !important; 
                font-size: 11pt;
                color: black;
            }
            
            /* Force table to take full A4 width */
            .table { 
                width: 100% !important; 
                table-layout: fixed !important; /* Forces columns to respect set widths */
                border: 1px solid #000 !important;
            }
            .table td, .table th { 
                border: 1px solid #000 !important; 
                padding: 6px !important;
            }
            .signature-box { border: 1px solid #000; height: 100px; }
        }
    </style>
</head>
<body>

<!-- PIN Logic -->
<script id="auth-gate">
  (function() {
    const _secret = "31393134"; // Hex for 1914
    const _v = (s) => s.split('').map(c => c.charCodeAt(0).toString(16)).join('') === _secret;
    while (true) {
      let p = prompt("Please enter the PIN to access this page:");
      if (p === null) { document.body.innerHTML = "<h1>Access Denied</h1>"; break; }
      if (_v(p)) {
        document.body.style.display = "block";
        document.getElementById('auth-gate').remove(); 
        break;
      } else { alert("Incorrect PIN."); }
    }
  })();
</script>

<div class="container main-container">
    <div class="text-center mb-4">
        <h2 class="text-uppercase"><i class="bi bi-clipboard-check me-2"></i>TSV Revised Checklist</h2>
        <p class="text-muted">Technical Support for Video Streaming</p>
    </div>

    <!-- Top Form Section -->
    <div class="card border-0 bg-light mb-4 p-3">
        <div class="row g-3">
            <div class="col-3">
                <label class="form-label fw-bold small text-muted">SESSION</label>
                <select id="session" class="form-select form-select-sm sync" data-target="p-session">
                    <option value="">Select session...</option>
                    <option>Tuesday 8:45pm</option>
                    <option>Friday 8:45pm</option>
                    <option>Saturday 6:45am</option>
                    <option>Sunday 10:45am</option>
                    <option value="other">Other</option>
                </select>
                <span id="p-session" class="print-val"></span>
                <input type="text" id="sessionOther" class="form-control form-control-sm mt-1 sync" data-target="p-sessionOther" style="display:none;" placeholder="Specify other...">
                <span id="p-sessionOther" class="print-val"></span>
            </div>
            
            <div class="col-5 position-relative">
                <label class="form-label fw-bold small text-muted">TSV OPERATOR(S)</label>
                <input type="text" id="operator" class="form-control form-control-sm sync" data-target="p-operator" placeholder="Enter name(s)..." autocomplete="off">
                <span id="p-operator" class="print-val border-bottom fw-bold"></span>
                <div id="nameSuggestions" class="list-group position-absolute w-100 shadow mt-1"></div>
            </div>

            <div class="col-2">
                <label class="form-label fw-bold small text-muted">DATE</label>
                <input type="date" id="topDate" class="form-control form-control-sm sync" data-target="p-date">
                <span id="p-date" class="print-val"></span>
            </div>
            <div class="col-2">
                <label class="form-label fw-bold small text-muted">TIME</label>
                <input type="time" id="topTime" class="form-control form-control-sm sync" data-target="p-time">
                <span id="p-time" class="print-val"></span>
            </div>
        </div>
    </div>

    <!-- Checklist Table -->
    <table class="table table-bordered table-sm">
        <thead>
            <tr class="text-center">
                <th style="width: 40px;">#</th>
                <th>Task Description</th>
                <th style="width: 60px;">Opo</th>
                <th style="width: 60px;">Hindi</th>
                <th style="width: 280px;">Note / Reason</th>
            </tr>
        </thead>
        <tbody id="checklistBody">
            <!-- Generated via JS -->
        </tbody>
    </table>

    <!-- Footer Area -->
    <div class="row mt-4 pt-3 border-top g-4">
        <div class="col-7">
            <h6 class="fw-bold mb-2">Mga naging suliranin sa pagtupad:</h6>
            <textarea id="remarks" class="form-control sync" data-target="p-remarks" rows="6" placeholder="Please detail any technical or operational issues encountered..."></textarea>
            <div id="p-remarks" class="print-val" style="min-height: 120px; border: 1px solid #eee; padding: 5px;"></div>
        </div>
        
        <div class="col-5">
            <div class="card p-3 border">
                <div class="mb-3">
                    <label class="small fw-bold">M/PD:</label>
                    <input type="text" id="pdm" class="form-control form-control-sm sync" data-target="p-pdm" placeholder="Nangasiwang M (PD kung wala)">
                    <span id="p-pdm" class="print-val border-bottom fw-bold"></span>
                </div>
                
                <label class="form-label fw-bold small text-secondary">TSV(s) SIGNATURE</label>
                <canvas id="signature" class="signature-box"></canvas>
                <div class="text-end mt-1 no-print">
                    <button class="btn btn-link btn-sm text-danger text-decoration-none" onclick="clearSig()">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
   <div class="text-center mt-5 no-print">
    <button class="btn btn-primary px-5 btn-lg shadow" onclick="window.print()">
        <i class="bi bi-file-pdf-fill me-2"></i> Save Checklist as PDF
    </button>		
    <!-- NEW BUTTON -->
    <button id="submitBtn" class="btn btn-success px-5 btn-lg shadow ms-2" onclick="uploadToCloud()">
        <i class="bi bi-cloud-upload-fill me-2"></i> Submit to Cloud
    </button>
    <div id="statusMsg" class="mt-3 fw-bold"></div>
</div>
</div>

<script>
// --- CONFIG ---
const tsvNames = ["Louie Alma", "Mark Morgan Miranda", "Esmer Buan", "Paul Vincent Crespo", "Jomar Soriano", "Andrey Buan", "Dominic Soriano", "Christopher Lloyd Jardeleza", "Dominic Mateo", "Karl Stephen Alma", "Joshua Esposo", "Carla Mae Vidal (Trainee)", "Megan Chloe Alma (Trainee)", "Aven Chrysler Alcalde (Trainee)", "Aedriel Buan (Trainee)"];

const tasks = [
    "Nabuksan ba lahat ng kagamitan at naiset ang Audio levels sa Standard Settings?",
    "Na-set up ba ang Webex bago ang laro (hard mute, reactions off, share content off)?",
    "Na-check ba ang files na gagamitin (Video/Awit week number, Timestamp ng pagpapatayo)?",
    "Na-coordinate ba sa mga mang-aawit ang takda ng mga awit (Live at Video File)?",
    "Nagawa ba ang pakikipag coordinate sa PD o M na mangunguna?",
    "Maayos ba ang backup computer - both Video/Audio?",
    "Maayos ba ang Audio at Video sa bawat rooms?",
    "Nai-setup o nai-saayos ba ang ba ang English na laro?",
    "Na turn off ba ng maayos ang lahat ng kagamitan bago linisin ang TSV Area?",
    "Iba pang bagay na hindi nailagay sa itaas (Pakilagay sa Note sa kanan)"
];

// --- GENERATION ---
const tbody = document.getElementById('checklistBody');
tasks.forEach((t, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td class="text-center fw-bold text-muted">${i+1}</td>
        <td class="small" style="padding: 8px;">${t}</td>
        <td class="text-center">
            <input type="checkbox" class="form-check-input opo" data-i="${i}">
            <span class="print-val fw-bold" id="p-opo-${i}"></span>
        </td>
        <td class="text-center">
            <input type="checkbox" class="form-check-input hindi" data-i="${i}">
            <span class="print-val fw-bold" id="p-hindi-${i}"></span>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm sync" data-target="p-note-${i}">
            <span id="p-note-${i}" class="print-val small"></span>
        </td>
    `;
    tbody.appendChild(tr);
});

// --- MIRRORING LOGIC (Syncs text to print spans) ---
document.addEventListener('input', (e) => {
    if (e.target.classList.contains('sync')) {
        const targetId = e.target.getAttribute('data-target');
        document.getElementById(targetId).textContent = e.target.value;
    }
    
    if (e.target.type === 'checkbox') {
        const idx = e.target.dataset.i;
        if (e.target.classList.contains('opo')) {
            if(e.target.checked) document.querySelector(`.hindi[data-i="${idx}"]`).checked = false;
        } else {
            if(e.target.checked) document.querySelector(`.opo[data-i="${idx}"]`).checked = false;
        }
        document.getElementById(`p-opo-${idx}`).textContent = document.querySelector(`.opo[data-i="${idx}"]`).checked ? "X" : "";
        document.getElementById(`p-hindi-${idx}`).textContent = document.querySelector(`.hindi[data-i="${idx}"]`).checked ? "X" : "";
    }
});

// --- NAME SUGGESTIONS ---
const opInput = document.getElementById('operator');
const sugBox = document.getElementById('nameSuggestions');

opInput.addEventListener('input', function() {
    const val = this.value;
    const lastPart = val.split(',').pop().trim().toLowerCase();
    sugBox.innerHTML = '';
    if (lastPart === "" && !val.endsWith(',')) { sugBox.style.display = 'none'; return; }

    const matches = tsvNames.filter(n => n.toLowerCase().includes(lastPart));
    if (matches.length > 0) {
        matches.forEach(name => {
            const btn = document.createElement('button');
            btn.className = "list-group-item list-group-item-action py-2 small";
            btn.textContent = name;
            btn.onclick = () => {
                let parts = val.split(',');
                parts.pop();
                parts.push(name);
                opInput.value = parts.join(', ') + ', ';
                document.getElementById('p-operator').textContent = opInput.value;
                sugBox.style.display = 'none';
                opInput.focus();
            };
            sugBox.appendChild(btn);
        });
        sugBox.style.display = 'block';
    }
});

// Session Selection
document.getElementById('session').addEventListener('change', function() {
    document.getElementById('sessionOther').style.display = this.value === 'other' ? 'block' : 'none';
    document.getElementById('p-session').textContent = this.value;
});

// --- SIGNATURE ---
const canvas = document.getElementById('signature');
const ctx = canvas.getContext('2d');
let drawing = false;
canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;

const getPos = (e) => {
    const rect = canvas.getBoundingClientRect();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: cx - rect.left, y: cy - rect.top };
};

const start = (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); };
const draw = (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
const stop = () => drawing = false;

canvas.addEventListener('mousedown', start);
canvas.addEventListener('mousemove', draw);
window.addEventListener('mouseup', stop);
canvas.addEventListener('touchstart', (e) => { e.preventDefault(); start(e); }, {passive:false});
canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); }, {passive:false});
canvas.addEventListener('touchend', stop);

function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

// Initialization
document.getElementById('topDate').valueAsDate = new Date();
document.getElementById('p-date').textContent = document.getElementById('topDate').value;
document.addEventListener('click', (e) => { if(!opInput.contains(e.target)) sugBox.style.display = 'none'; });

async function uploadToCloud() {
    const btn = document.getElementById('submitBtn');
    const status = document.getElementById('statusMsg');
    
    // Replace this URL with the one you copied from Google Apps Script deployment
	const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCFxyDEUMMsM2p07TGJJnG8wtLnC9FY9IsUP7-YdYxpV7-hMiuYuEC3hEW016K6mvm/exec";
	

    // Disable button to prevent double submission
    btn.disabled = true;
    status.innerText = "Uploading... Please wait.";
    status.className = "mt-3 fw-bold text-primary";

    // 1. Gather Task Data
    const taskResults = [];
    tasks.forEach((t, i) => {
        const isOpo = document.querySelector(`.opo[data-i="${i}"]`).checked;
        const isHindi = document.querySelector(`.hindi[data-i="${i}"]`).checked;
        const note = document.querySelector(`[data-target="p-note-${i}"]`).value;
        taskResults.push({ task: i + 1, status: isOpo ? "Opo" : (isHindi ? "Hindi" : "N/A"), note: note });
    });

    // 2. Gather Signature
    const sigData = canvas.toDataURL(); // Converts signature to image string

    // 3. Prepare Payload
    const payload = {
        session: document.getElementById('session').value || document.getElementById('sessionOther').value,
        operator: document.getElementById('operator').value,
        topDate: document.getElementById('topDate').value,
        topTime: document.getElementById('topTime').value,
        remarks: document.getElementById('remarks').value,
        pdm: document.getElementById('pdm').value,
        tasks: taskResults,
        signature: ""
    };

    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Essential for Google Apps Script
            cache: 'no-cache',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        // Since we use 'no-cors', we can't always read the response body, 
        // but if it doesn't throw an error, it usually succeeded.
        status.innerText = "âœ“ Successfully submitted to Google Drive!";
        status.className = "mt-3 fw-bold text-success";
        btn.innerHTML = "Submitted!";
    } catch (error) {
        console.error(error);
        status.innerText = "Error: Could not connect to the server.";
        status.className = "mt-3 fw-bold text-danger";
        btn.disabled = false;
    }
}
</script>

</body>
</html>

